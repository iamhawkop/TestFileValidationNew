package utils;

import org.sikuli.script.Pattern;
import org.sikuli.script.Screen;

public class SikuliUtils {
    private static final Screen screen = new Screen();

    // Click on an image
    public static void click(String imageName, int waitTime) throws Exception {
        Pattern pattern = new Pattern("src/test/resources/sikuli_images/" + imageName + ".png");
        screen.wait(pattern, waitTime);
        screen.click(pattern);
    }

    // Type text into an input box
    public static void type(String text) throws Exception {
        screen.type(text);
    }

    // Check if an image exists
    public static boolean exists(String imageName, int waitTime) throws Exception {
        Pattern pattern = new Pattern("src/test/resources/sikuli_images/" + imageName + ".png");
        return screen.exists(pattern, waitTime) != null;
    }
}

stepdef

import io.cucumber.java.en.Then;
import utils.SikuliUtils;

import javax.imageio.ImageIO;
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.File;

public class DownloadPdfSteps {

    @Then("I download pdf, save with sikuli, open in adobe, take screenshot and close")
    public void download_and_handle_pdf() throws Exception {
        String downloadPath = System.getProperty("user.dir") + "\\target\\downloads";
        new File(downloadPath).mkdirs(); // ensure folder exists

        // Step 1: Handle Save As dialog with Sikuli
        SikuliUtils.click("filename_box", 10); 
        SikuliUtils.type(downloadPath + "\\myDownloadedFile.pdf");
        SikuliUtils.click("save_button", 10);

        System.out.println("âœ… File saved at: " + downloadPath);

        // Step 2: Open saved PDF in Adobe
        File pdfFile = new File(downloadPath + "\\myDownloadedFile.pdf");
        if (!pdfFile.exists()) {
            throw new RuntimeException("File not found: " + pdfFile.getAbsolutePath());
        }

        Desktop.getDesktop().open(pdfFile);

        // Wait for Adobe to open
        Thread.sleep(4000);

        // Step 3: Take screenshot of entire screen
        Rectangle screenRect = new Rectangle(Toolkit.getDefaultToolkit().getScreenSize());
        BufferedImage screenFullImage = new Robot().createScreenCapture(screenRect);

        String screenshotPath = downloadPath + "\\pdf_screenshot.png";
        ImageIO.write(screenFullImage, "png", new File(screenshotPath));
        System.out.println("ðŸ“¸ Screenshot saved at: " + screenshotPath);

        // Step 4: Close Adobe using Sikuli
        SikuliUtils.click("close_button", 10);

        System.out.println("âœ… Adobe closed successfully");
    }
}

package steps;

import io.cucumber.java.en.Then;
import org.sikuli.script.Key;
import org.sikuli.script.Pattern;
import org.sikuli.script.Screen;

public class SaveAsSteps {

    @Then("I handle save as dialog and save pdf with sikuli offset")
    public void handleSaveAsWithOffset() throws Exception {
        Screen screen = new Screen();

        // Build paths dynamically
        String baseDir = System.getProperty("user.dir") + "\\src\\test\\resources\\sikuli_images\\";
        String downloadPath = System.getProperty("user.dir") + "\\target\\downloads\\myDownloadedFile.pdf";

        // Step 1: Find "File name:" label
        Pattern fileNameLabel = new Pattern(baseDir + "file_name_label.png").similar(0.9f);
        screen.wait(fileNameLabel, 10);

        // Step 2: Click with offset (e.g., 120px to right â†’ lands inside input box)
        screen.click(fileNameLabel.targetOffset(120, 0));

        // Step 3: Clear existing text
        screen.type("a", Key.CTRL);   // Select all
        screen.type(Key.BACKSPACE);   // Delete

        // Step 4: Type new filename
        screen.type(downloadPath);

        // Step 5: Click Save button
        Pattern saveBtn = new Pattern(baseDir + "save_button.png").similar(0.9f);
        screen.wait(saveBtn, 10);
        screen.click(saveBtn);

        System.out.println("âœ… File saved successfully at: " + downloadPath);
    }
}
